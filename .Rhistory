column_to_rownames(var = "Row.names") %>%
dplyr::filter(!(is.na(padj)))
## Filter the result
res_filt <- res %>%
dplyr::filter(padj < 0.05,
abs(log2FoldChange) > params$logfc_thresh) %>%
dplyr::arrange(desc(log2FoldChange))
res_filt
View(res)
View(pre_process_results)
## Merge all results together
log2_counts <- log2(raw_counts+1)
## Merge all results together
log2_counts <- log2(pre_process_results$raw_filt+1)
## Norm counts :  ####
n_fact <- estimateSizeFactorsForMatrix(pre_process_results$raw_filt)
tmp <- sweep(pre_process_results$raw_filt, 2, n_fact, FUN="/")
n_counts <- list(n_counts = tmp,
n_counts_log2 = log2(tmp+1),
n_counts_log10 = log10(tmp+1))
rm(n_fact,tmp,log2_counts, DESeqObj)
colnames(n_counts$n_counts_log2) <- paste0(colnames(n_counts$n_counts_log2),"_log2")
colnames(n_counts$n_counts_log10) <- paste0(colnames(n_counts$n_counts_log10),"_log10")
colnames(n_counts$n_counts) <- paste0("norm_",colnames(n_counts$n_counts))
View(res)
View(res)
## Combining the counts
all_results <- cbind(pre_process_results$raw_filt,
n_counts$n_counts,
n_counts$n_counts_log2,
n_counts$n_counts_log10,
res)
View(all_results)
View(all_results)
quantile(res$padj)
1e-01
1e-08
1e-02
2e-01
seq(1, 10)
View(res_filt)
all_results <- all_results %>%
dplyr::mutate(Log_basemean = log10(baseMean),
Rank = case_when(padj < 1e-100 ~
round(log2FoldChange*(-log10(1e-100))/50, 4),
padj >= 1e-100 & padj < 1e-50 ~
round(log2FoldChange*(-log10(1e-70))/50, 4),
padj >= 1e-50 & padj < 1e-20 ~
round(log2FoldChange*(-log10(1e-30))/50, 4),
padj >= 1e-20 & padj < 1e-10 ~
round(log2FoldChange*(-log10(1e-15))/50, 4),
padj >= 1e-10 & padj < 1e-05 ~
round(log2FoldChange*(-log10(1e-07))/50, 4),
padj >= 1e-05 & padj < 0.3 ~
round(log2FoldChange*(-log10(padj))/50, 4),
padj >= 0.3 ~ 0)) %>%
dplyr::arrange(desc(Rank)) %>%
dplyr::mutate(Rank_idx = seq(1, nrow(all_results)))
## Final result (filtered)
all_results_filt <- all_results[rownames(res_filt),]
View(all_results_filt)
View(all_results)
View(all_results_filt)
-log10(1e-100)
100/30
View(all_results)
View(res_filt)
View(all_results_filt)
all_results <- cbind(pre_process_results$raw_filt,
n_counts$n_counts,
n_counts$n_counts_log2,
n_counts$n_counts_log10,
res)
View(all_results)
all_results <- all_results %>%
dplyr::mutate(Log_basemean = log10(baseMean),
Rank = case_when(padj < 1e-100 ~
round(log2FoldChange*(-log10(1e-100))/30, 4),
padj >= 1e-100 & padj < 1e-50 ~
round(log2FoldChange*(-log10(1e-70))/30, 4),
padj >= 1e-50 & padj < 1e-20 ~
round(log2FoldChange*(-log10(1e-30))/30, 4),
padj >= 1e-20 & padj < 1e-10 ~
round(log2FoldChange*(-log10(1e-15))/30, 4),
padj >= 1e-10 & padj < 1e-05 ~
round(log2FoldChange*(-log10(1e-07))/30, 4),
padj >= 1e-05 & padj < 0.3 ~
round(log2FoldChange*(-log10(padj))/30, 4),
padj >= 0.3 ~ 0)) %>%
dplyr::arrange(desc(Rank)) %>%
dplyr::mutate(Rank_idx = seq(1, nrow(all_results)))
View(all_results)
2*(-log10(0.1))
2*(-log10(0.07))
2*(-log10(0.002))
View(res_filt)
## Final result (filtered)
all_results_filt <- all_results %>%
dplyr::filter(padj < 0.05,
abs(log2FoldChange) > params$logfc_thresh)
View(all_results_filt)
write_xlsx(all_results, path = paste0(out_obj, "dea_results.xlsx"))
write_xlsx(all_results_filt, path = paste0(out_obj, "dea_results_filt.xlsx"))
View(all_results)
## ---------------------------------------------- 3. Volcano plot (DEA)
My_volcano <- function(df,
x= "log2FoldChange",
y= "padj",
lab= "Gene_name",
point_size= 2,
label_genes= F,
lab_size= 3,
lab_max_overlap= 20,
lab_box.padding= 0.5,
lab_colour = "navy",
lab_fill = "white",
lab_force_pull = .5,
selected_genes= NULL,
logFC_thresh= 1.5,
padj_thresh= 1e-5,
col_palette= NULL,
extend_xlim= 0.5){
if(!(is.data.frame(df))){
stop("your object isn't a dataframe !")
}
if(!all(c(x, y) %in% colnames(df))){
stop(paste0("<",x,"> or <",y,"> isn't found in your dataframe !"))
}
hline <- -log10(padj_thresh)
vline <- logFC_thresh
## Select genes :
if(is.null(selected_genes)){
selected_genes <- df %>%
dplyr::filter(.data[[y]] < 1e-10,
abs(.data[[x]]) > 2) %>%
dplyr::pull(.data[[lab]])
}
## Color palette :
if(is.null(col_palette)){
col_palette <- c("pval & logFC"="darkred",
"logFC"="darkgreen",
"p-value"="midnightblue",
"NS"="lightgray")
} else {
if(length(col_palette) < 4){
warning("The provided palette is of length < 4 ; therefor we're using default palette")
col_palette <- c("pval & logFC"="darkred",
"logFC"="darkgreen",
"p-value"="midnightblue",
"NS"="lightgray")
} else {
col_palette <- c("pval & logFC" = col_palette[1],
"logFC" = col_palette[2],
"p-value" = col_palette[3],
"NS" = col_palette[4])
}
}
## plot :
df %>%
dplyr::mutate(Col = case_when(abs(.data[[x]]) > logFC_thresh &
.data[[y]] < padj_thresh ~ "pval & logFC",
abs(.data[[x]]) > logFC_thresh &
.data[[y]] > padj_thresh ~ "logFC",
abs(.data[[x]]) < logFC_thresh &
.data[[y]] < padj_thresh ~ "p-value",
abs(.data[[x]]) < logFC_thresh &
.data[[y]] > padj_thresh ~ "NS",
TRUE ~ "NS"),
Sel_genes = ifelse(.data[[lab]] %in% selected_genes,
.data[[lab]],
NA)) -> df.plot
if(isFALSE(label_genes)){
plt <- df.plot %>%
ggplot(aes(x= .data[[x]],
y= -log10(.data[[y]])))+
geom_vline(xintercept = -(vline), linetype = 2, color = "black", linewidth = .4)+
geom_vline(xintercept = vline, linetype = 2, color = "black", linewidth = .4)+
geom_hline(yintercept = hline, linetype = 2, color = "black", linewidth = .4)+
geom_point(aes(colour = Col),
size = point_size,
alpha = 0.6)+
labs(title = "Volcano Plot",
caption = paste0("Number of genes : ", nrow(df)))+
theme(legend.position = "top",
legend.margin = margin(b=.05, unit = "in"),
legend.key = element_rect(colour = "white"),
panel.background = element_rect(fill = "white",
colour = "darkgray",
linewidth = .5),
legend.text = element_text(size = 13,
color = "black",
face = "bold"),
axis.title = element_text(size = 14,
face = "bold",
colour = "darkred"),
axis.title.x = element_text(margin = margin(t=12)),
axis.title.y = element_text(margin = margin(r=12)),
axis.text = element_text(size = 12,
colour = "black"),
plot.title = element_text(size = 16,
face = "bold",
colour = "darkred",
margin = margin(b=12)),
plot.caption = element_text(size = 13,
colour = "black"))+
guides(colour = guide_legend(title = NULL,
override.aes = list(size = 5)))+
scale_color_manual(values = col_palette)+
xlim(c((min(df[[x]]) - extend_xlim),(max(df[[x]]) + extend_xlim)))
} else {
plt <- df.plot %>%
ggplot(aes(x= .data[[x]],
y= -log10(.data[[y]])))+
geom_vline(xintercept = -(vline), linetype = 2, color = "black", linewidth = .4)+
geom_vline(xintercept = vline, linetype = 2, color = "black", linewidth = .4)+
geom_hline(yintercept = hline, linetype = 2, color = "black", linewidth = .4)+
geom_point(aes(colour = Col),
size = point_size,
alpha = 0.6)+
labs(title = "Volcano Plot",
caption = paste0("Number of genes : ", nrow(df)))+
theme(legend.position = "top",
legend.margin = margin(b=.05, unit = "in"),
legend.key = element_rect(colour = "white"),
panel.background = element_rect(fill = "white",
colour = "darkgray",
linewidth = .5),
legend.text = element_text(size = 13,
color = "black",
face = "bold"),
axis.title = element_text(size = 14,
face = "bold",
colour = "darkred"),
axis.title.x = element_text(margin = margin(t=12)),
axis.title.y = element_text(margin = margin(r=12)),
axis.text = element_text(size = 12,
colour = "black"),
plot.title = element_text(size = 16,
face = "bold",
colour = "darkred",
margin = margin(b=12)),
plot.caption = element_text(size = 13,
colour = "black"))+
guides(colour = guide_legend(title = NULL,
override.aes = list(size = 5)))+
scale_color_manual(values = col_palette)+
xlim(c((min(df[[x]]) - extend_xlim),(max(df[[x]]) + extend_xlim)))+
geom_label_repel(aes(label = .data[["Sel_genes"]]),
size = lab_size,
max.overlaps = lab_max_overlap,
box.padding = lab_box.padding,
label.r = 0.4,
label.size = .25,
force_pull = lab_force_pull,
colour = lab_colour,
fill = lab_fill)
}
return(plt)
}
My_volcano(all_results_filt)
View(My_volcano)
View(my_scatter_theme)
My_volcano(all_results_filt,
x= "log2FoldChange",
y= "padj",
lab= "Gene_name",
point_size= 2,
label_genes= F,
lab_size= 3,
lab_max_overlap= 20,
lab_box.padding= 0.5,
lab_colour = "navy",
lab_fill = "white",
lab_force_pull = .5,
selected_genes= NULL,
logFC_thresh= 1.5,
padj_thresh= 1e-5,
col_palette= NULL,
extend_xlim= 0.5)+
theme(
plot.background = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
legend.background = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
legend.key = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
)
My_volcano(all_results_filt,
x= "log2FoldChange",
y= "padj",
lab= "Gene_name",
point_size= 2,
label_genes= F,
lab_size= 3,
lab_max_overlap= 20,
lab_box.padding= 0.5,
lab_colour = "navy",
lab_fill = "white",
lab_force_pull = .5,
selected_genes= NULL,
logFC_thresh= 1.5,
padj_thresh= 1e-5,
col_palette= NULL,
extend_xlim= 0.5)+
theme(
plot.background = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
legend.background = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
legend.key = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
plot.title = element_text(colour = "darkcyan", face = "bold", margin = margin(b=0.15, unit = "in"), size = 14)
)
My_volcano(all_results_filt,
x= "log2FoldChange",
y= "padj",
lab= "Gene_name",
point_size= 2,
label_genes= F,
lab_size= 3,
lab_max_overlap= 20,
lab_box.padding= 0.5,
lab_colour = "navy",
lab_fill = "white",
lab_force_pull = .5,
selected_genes= NULL,
logFC_thresh= 1.5,
padj_thresh= 1e-5,
col_palette= NULL,
extend_xlim= 0.5)+
theme(
plot.background = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
legend.background = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
legend.key = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
plot.title = element_text(colour = "darkcyan", face = "bold", margin = margin(b=0.15, unit = "in"), size = 14),
axis.title = element_text(colour = "darkcyan", face = "bold", size = 12)
)
My_volcano(all_results_filt,
x= "log2FoldChange",
y= "padj",
lab= "Gene_name",
point_size= 2,
label_genes= F,
lab_size= 3,
lab_max_overlap= 20,
lab_box.padding= 0.5,
lab_colour = "navy",
lab_fill = "white",
lab_force_pull = .5,
selected_genes= NULL,
logFC_thresh= 1.5,
padj_thresh= 1e-5,
col_palette= NULL,
extend_xlim= 0.5)+
theme(
plot.background = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
legend.background = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
legend.key = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
plot.title = element_text(colour = "darkcyan", face = "bold", margin = margin(b=0.15, unit = "in"), size = 14),
axis.title = element_text(colour = "darkcyan", face = "bold", size = 12),
axis.text = element_text(size = 11)
)
My_volcano(all_results_filt,
x= "log2FoldChange",
y= "padj",
lab= "Gene_name",
point_size= 2,
label_genes= F,
lab_size= 3,
lab_max_overlap= 20,
lab_box.padding= 0.5,
lab_colour = "navy",
lab_fill = "white",
lab_force_pull = .5,
selected_genes= NULL,
logFC_thresh= 1.5,
padj_thresh= 1e-5,
col_palette= NULL,
extend_xlim= 0.5)+
theme(
plot.background = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
legend.background = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
legend.key = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
plot.title = element_text(colour = "darkcyan", face = "bold", margin = margin(b=0.15, unit = "in"), size = 14),
axis.title = element_text(colour = "darkcyan", face = "bold", size = 12),
axis.text = element_text(size = 11),
legend.text = element_text(size = 12)
)
My_volcano(all_results_filt,
x= "log2FoldChange",
y= "padj",
lab= "Gene_name",
point_size= 2,
label_genes= F,
lab_size= 3,
lab_max_overlap= 20,
lab_box.padding= 0.5,
lab_colour = "navy",
lab_fill = "white",
lab_force_pull = .5,
selected_genes= NULL,
logFC_thresh= 1.5,
padj_thresh= 1e-5,
col_palette= NULL,
extend_xlim= 0.5)+
theme(
plot.background = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
legend.background = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
legend.key = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
plot.title = element_text(colour = "darkcyan", face = "bold", margin = margin(b=0.15, unit = "in"), size = 14),
axis.title = element_text(colour = "darkcyan", face = "bold", size = 12),
axis.text = element_text(size = 11),
legend.text = element_text(size = 12)
)
My_volcano(all_results_filt,
x= "log2FoldChange",
y= "padj",
lab= "Gene_name",
point_size= 2,
label_genes= T,
lab_size= 2,
lab_max_overlap= 20,
lab_box.padding= 0.5,
lab_colour = "navy",
lab_fill = "white",
lab_force_pull = .5,
selected_genes= NULL,
logFC_thresh= 1.5,
padj_thresh= 1e-5,
col_palette= NULL,
extend_xlim= 0.5)+
theme(
plot.background = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
legend.background = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
legend.key = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
plot.title = element_text(colour = "darkcyan", face = "bold", margin = margin(b=0.15, unit = "in"), size = 14),
axis.title = element_text(colour = "darkcyan", face = "bold", size = 12),
axis.text = element_text(size = 11),
legend.text = element_text(size = 12)
)
My_volcano(all_results_filt,
x= "log2FoldChange",
y= "padj",
lab= "Gene_name",
point_size= 2,
label_genes= T,
lab_size= 3,
lab_max_overlap= 20,
lab_box.padding= 0.5,
lab_colour = "navy",
lab_fill = "white",
lab_force_pull = .5,
selected_genes= NULL,
logFC_thresh= 1.5,
padj_thresh= 1e-5,
col_palette= NULL,
extend_xlim= 0.5)+
theme(
plot.background = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
legend.background = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
legend.key = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
plot.title = element_text(colour = "darkcyan", face = "bold", margin = margin(b=0.15, unit = "in"), size = 14),
axis.title = element_text(colour = "darkcyan", face = "bold", size = 12),
axis.text = element_text(size = 11),
legend.text = element_text(size = 12)
)
My_volcano(all_results_filt,
x= "log2FoldChange",
y= "padj",
lab= "Gene_name",
point_size= 2,
label_genes= T,
lab_size= 3,
lab_max_overlap= 20,
lab_box.padding= 0.5,
lab_colour = "navy",
lab_fill = "white",
lab_force_pull = .5,
selected_genes= NULL,
logFC_thresh= 1.5,
padj_thresh= 1e-10,
col_palette= NULL,
extend_xlim= 0.5)+
theme(
plot.background = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
legend.background = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
legend.key = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
plot.title = element_text(colour = "darkcyan", face = "bold", margin = margin(b=0.15, unit = "in"), size = 14),
axis.title = element_text(colour = "darkcyan", face = "bold", size = 12),
axis.text = element_text(size = 11),
legend.text = element_text(size = 12)
)
My_volcano(all_results_filt,
x= "log2FoldChange",
y= "padj",
lab= "Gene_name",
point_size= 3,
label_genes= T,
lab_size= 3,
lab_max_overlap= 15,
lab_box.padding= 0.4,
lab_colour = "navy",
lab_fill = "white",
lab_force_pull = .5,
selected_genes= NULL,
logFC_thresh= 1.5,
padj_thresh= 1e-10,
col_palette= NULL,
extend_xlim= 0.5)+
theme(
plot.background = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
legend.background = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
legend.key = element_rect(colour = "whitesmoke", fill = "whitesmoke"),
plot.title = element_text(colour = "darkcyan", face = "bold", margin = margin(b=0.15, unit = "in"), size = 14),
axis.title = element_text(colour = "darkcyan", face = "bold", size = 12),
axis.text = element_text(size = 11),
legend.text = element_text(size = 12)
)
